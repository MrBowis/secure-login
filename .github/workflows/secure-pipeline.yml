name: ğŸ›¡ï¸ AnÃ¡lisis de Seguridad EstÃ¡tico con IA

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  static-security-analysis:
    name: ğŸ§  AnÃ¡lisis EstÃ¡tico de Vulnerabilidades (IA)
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Obtener cÃ³digo fuente
        uses: actions/checkout@v4

      - name: ğŸ Configurar Python (Para el Scanner IA)
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: ğŸ“¦ Instalar dependencias del Scanner
        run: |
          pip install joblib scikit-learn xgboost pandas numpy dill
          # Si tienes un requirements.txt especÃ­fico para el modelo, Ãºsalo aquÃ­
          # pip install -r model_requirements.txt

      - name: ğŸ§  Ejecutar Escaneo de IA
        id: ia_scan
        run: |
          # Asegurarse que los archivos .pkl del modelo estÃ©n en la raÃ­z o ajustar la ruta
          python security_scan.py
        continue-on-error: false # Si detecta vulnerabilidad, falla el pipeline

      - name: ğŸ“Š Publicar Reporte de Seguridad (Si es PR)
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            let report = "âš ï¸ Vulnerabilidad detectada por el Modelo de IA.";
            try { 
              if (fs.existsSync('security_report.txt')) {
                report = fs.readFileSync('security_report.txt', 'utf8');
              }
            } catch(e) { console.log(e); }
            
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: "### ğŸ›‘ Bloqueo de Seguridad\n\n" + report
            });